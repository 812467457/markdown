# 尚筹网复习

## 一、后台关联系统

### 1、环境搭建

* 创建maven项目。有一个父工程做依赖的整合和管理。

* 数据库创建，根据创建好的数据库，使用Mybatis的插件逆向工程生成实体类和mapper

* 整合Mybatis
  * 准备一个jdbc.properties文件，存放数据库连接信息。
  * 准备一个spring和mybatis整合的配置文件。
    * 配置数据源
    * 配置sqlSessionFactoryBean整合mybatis
    * 配置mapperScannerConfiguration扫描mapper接口
* 日志系统
  * 这里选用的slf4j+logback日志系统
  * 导入所需依赖
  * 准备一个日志的配置文件
  * 配置日志输出位置，输出格式，日志级别等。
* 声明式事务，保证对数据库的操作要么一起成功要么一起失败
  * 使用spring的AOP配置声明式事务，加入AOP的依赖
  * 准备一个spring配置事务的配置文件
    * 配置自动扫描包，扫描service到IOC容器
    * 配置事务管理器，装配数据源
    * 配置AOP
      * 切入点表达式
      * 把事务通知和切入点表达式连到一起
    * 配置事务通知
      * 查询方法配置为只读
      * 增删改方法配置传播行为REQUIRES_NEW，配置回滚Exception

* 表述层配置

  * 加入SpringMVC依赖
  * 配置web.xml
    * 根据Spring的配置文件初始化容器
    * 配置characterEncodingFilter设置编码格式
    * 配置前端控制器dispatcherServlet,使其在容器启动时就初始化
    * 配置dispatcherServlet的映射地址,普通请求返回一个html后缀的页面实现伪静态效果,Ajax请求返回一个json的数据

  * SpringMVC配置文件
    * 配置自动扫描包，主要扫描一些表述层的组件，比如Controller、interceptor、配置类等。
    * 配置springMVC注解驱动
    * 配置视图解析器，前缀、后缀

* SpringMVC环境下的Ajax请求（普通请求返回一个页面，Ajax请求返回一个Json）
  * 导入相关依赖，加入Jquery
  * 创建一个ResultEntity类统一返回数据格式
* 异常映射
  * 因为要根据不同的请求返回不同的数据，Ajax请求返回的是一个Json的错误信息，而普通请求返回的是一个错误页面，所以在工具类中创建一个判断当前是什么请求的方法，根据消息头判断。
  * 基于XML方式实现异常映射，在SpringMVC配置文件配置simpleMappingExceptionResolver，指定异常名和对应视图



### 2、后台管理员登录

* 使用MD5加密
* 登录后的跳转使用重定向，避免重复提交表单
* 创建登录失败的异常提示
* 退出登录，设置session强制失效
* 创建一个拦截器类，用来判断用户是否登录
* 在mvc配置文件使用拦截器保护未登录不让访问的资源
* 在mvc配置文件中放行不需要拦截的资源



### 3、管理员维护

* 导入分页插件PageHelper的依赖
* 在spring整合mybatis的配置文件中的sessionFactoryBean中配置分页插件
* 使用Pageination插件展示页面分页栏
* 使用关键词查询时，保证分页带上关键词，在发起翻页请求时，把当前的关键词带上
* 用户的增删改操作，在添加用户时需要保证用户id的唯一性，如果重复的需要给出一个异常处理。更新用户时需要回显表单。



### 4、角色维护

* RBAC模型，一个用户可以对应多个角色，一个角色拥有多个权限，权限具体定义了用户可以访问哪些资源。
* 角色维护使用了Ajax请求进行数据传输，先跳转到页面，回调函数去后台获取数据，填充到表格。
* 因为该模块整体使用的Ajax请求，所以增加、修改操作也是弹出一个模态框进行异步操作，没有页面跳转。



### 5、菜单维护

* 菜单维护和角色维护大致相同。
* 使用到了树形结构
  * 首先需要在数据库中构建树形结构，通过pid（父节点）关联id（子节点），pid为null的就是根节点。
  * 在Java中表示树形结构，在Java实体类中需要一个List存储当前节点的子节点，还有一个是否打开树结构的的开关，返回数据的时候，遍历所有节点，找到根节点和所有节点的对应关系，再把对应好的节点存入父节点的List中，最后返回父节点。
  * 页面上显示树结构，引入zTree的环境，把后台返回的数据进行解析后填充到树结构上。



### 6、分配

* 给用户分配角色
  * 只有当用户具备某种角色，才能有某种角色下的权力
  * 需要一个用户和角色的中间表做关联
  * 查询出已分配和未分配的角色，分配时先把用户已分配的角色删除掉，再把勾选的角色的添加到用户中。
* 给角色分配权限和给用户分配角色相同



### 7、添加SpringSecurity

* 加入SpringSecurity依赖
* 在web.xml配置一个SpringSecurity的filter
* 使用配置类配置SpringSecurity，继承WebSecurityConfigurerAdapter
* 实现登录检测、密码加密、权限控制的功能
* 注意的地方：在之前使用context加载IOC容器时，存在一个加载顺序的问题，先加载了spring但是SpringSecurity在SpringMVC中还未加载，就会报找不到bean的错误，解决方式，不使用context加载IOC容器，使用DispatcherServlet来加载IOC容器，这样就可以保证在spring容器加载之前就存在SpringSecurity的环境了。



## 二、前台会员系统

### 1、环境搭建

* 搭建一个分布式环境，把每个模块拆分出来一个个的微服务

* 用到的组件
  * 注册中心：Eureka，把每个微服务注册到注册中心上，对其他微服务暴露当前微服务
  * 客户端负载均衡：Ribbon，指定以轮询或其他方式进行负载均衡
  * 声明式远程方法调用：Fegin，只需要创建一个接口并用注解方式配置它，即可完成服务提供方的接口绑定
  * 服务降级、熔断：Hystrix，如果某个微服务出现了故障，通过熔断监控应用是否出现故障，如果出现故障则触发降级机制，返回一个提前准备好的一个备选方案，防止长时间等待出现异常。
  * 网关：Zuul，主要用来对请求的路由和过滤两个功能，路由是把一个外部的请求转发到具体的微服务上，实现外部统一访问入口的基础，过滤主要是把请求处理过程进行干预，实现请求校验、聚合等功能。
  * 数据监控：Hystrix Dash Board，可以查看应用中详细的数据，比如某个微服务的访问量。



### 2、会员注册登录

* 注册
  * 使用第三方接口发送验证码短信，把验证码存入Redis，注册时以便校验

* 登录
  * 因为在分布式环境下，所以session不共享，登录后的用户不能携带登录数据跳转到其他服务，使用Session同步技术解决这一问题，使用Redis存储session的信息，导入SpringSession的依赖，配置Redis和SpringSession，注意，**存入Session的数据需要支持序列化，相当于SpringSession做了之前Tomcat对Session管理的功能。**



### 3、发起项目

* 总共有三个表的信息需要保存
* 每提交一个表单就先保存到session（redis）中，最后一次提交在进行数据库的保存
* 其中图片信息存储到阿里云OSS中
* 针对和页面交互使用VO对象，和数据库交互使用PO对象
* 注意序列化问题



### 4、展示项目

* 展示项目分类
* 展示项目
* 展示项目详情
* 展示项目回报信息



### 5、支付

确认回报信息

生成订单表，收集数据

调用支付宝接口，使用RSK2签名，非对称加密